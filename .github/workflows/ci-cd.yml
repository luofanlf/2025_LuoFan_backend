name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run tests
      run: mvn clean test
      
    # æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå·²ç§»é™¤ä»¥é¿å…æƒé™é—®é¢˜
    # æµ‹è¯•å¤±è´¥æ—¶workflowä¼šè‡ªåŠ¨åœæ­¢

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AWS EC2
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug Secrets
      run: |
        echo "ğŸ” è°ƒè¯•Secretsè®¾ç½®:"
        echo "EC2_HOSTå­˜åœ¨: ${{ secrets.EC2_HOST != '' }}"
        echo "EC2_USERå­˜åœ¨: ${{ secrets.EC2_USER != '' }}"
        echo "EC2_SSH_KEYå­˜åœ¨: ${{ secrets.EC2_SSH_KEY != '' }}"
        echo "EC2_HOSTå€¼: ${{ secrets.EC2_HOST }}"
        echo "EC2_USERå€¼: ${{ secrets.EC2_USER }}"
        echo "SSHå¯†é’¥é•¿åº¦: $(echo '${{ secrets.EC2_SSH_KEY }}' | wc -c)"
        echo "SSHå¯†é’¥å¼€å¤´: $(echo '${{ secrets.EC2_SSH_KEY }}' | head -c 30)..."
        echo "SSHå¯†é’¥ç»“å°¾: $(echo '${{ secrets.EC2_SSH_KEY }}' | tail -c 30)"
        
    - name: Test SSH Key Format
      run: |
        echo "ğŸ”‘ æµ‹è¯•SSHå¯†é’¥æ ¼å¼:"
        echo '${{ secrets.EC2_SSH_KEY }}' > /tmp/test_key
        chmod 600 /tmp/test_key
        if ssh-keygen -l -f /tmp/test_key 2>/dev/null; then
          echo "âœ… SSHå¯†é’¥æ ¼å¼æ­£ç¡®"
        else
          echo "âŒ SSHå¯†é’¥æ ¼å¼é”™è¯¯"
          echo "å°è¯•éªŒè¯å¯†é’¥å†…å®¹..."
          head -1 /tmp/test_key
          tail -1 /tmp/test_key
        fi
        rm -f /tmp/test_key
        
    - name: Test Network Connectivity
      run: |
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿é€šæ€§:"
        if ping -c 3 ${{ secrets.EC2_HOST }}; then
          echo "âœ… EC2å®ä¾‹ç½‘ç»œå¯è¾¾"
        else
          echo "âŒ EC2å®ä¾‹ç½‘ç»œä¸å¯è¾¾"
        fi
        
        echo "ğŸ”Œ æµ‹è¯•SSHç«¯å£:"
        if timeout 10 nc -z ${{ secrets.EC2_HOST }} 22; then
          echo "âœ… SSHç«¯å£22å¼€æ”¾"
        else
          echo "âŒ SSHç«¯å£22ä¸å¯è¾¾"
        fi
        
    - name: Deploy to EC2 with Debug
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        debug: true
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²è°ƒè¯•..."
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
          echo "å¯ç”¨ç£ç›˜ç©ºé—´: $(df -h /)"
          echo "å†…å­˜ä½¿ç”¨: $(free -h)"
          
          # è®¾ç½®å˜é‡
          REPO_URL="https://github.com/${{ github.repository }}.git"
          PROJECT_DIR="/home/ubuntu/tech-challenge"
          CONTAINER_NAME="tech-challenge-backend"
          IMAGE_NAME="tech-challenge-backend"
          
          echo "ğŸ“‹ éƒ¨ç½²å˜é‡:"
          echo "REPO_URL=$REPO_URL"
          echo "PROJECT_DIR=$PROJECT_DIR"
          echo "CONTAINER_NAME=$CONTAINER_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME"
          
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·
          echo "ğŸ“¦ æ›´æ–°ç³»ç»ŸåŒ…..."
          sudo apt update -y
          
          # å®‰è£…Gitï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰
          echo "ğŸ“¦ æ£€æŸ¥Gitå®‰è£…çŠ¶æ€..."
          if ! command -v git &> /dev/null; then
            echo "å®‰è£…Git..."
            sudo apt install -y git
          else
            echo "âœ… Gitå·²å®‰è£…: $(git --version)"
          fi
          
          # å®‰è£…Dockerï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰
          echo "ğŸ³ æ£€æŸ¥Dockerå®‰è£…çŠ¶æ€..."
          if ! command -v docker &> /dev/null; then
            echo "å®‰è£…Docker..."
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ubuntu
            echo "âœ… Dockerå®‰è£…å®Œæˆ"
          else
            echo "âœ… Dockerå·²å®‰è£…: $(docker --version)"
          fi
          
          # ç¡®ä¿DockeræœåŠ¡è¿è¡Œ
          echo "ğŸ”„ å¯åŠ¨DockeræœåŠ¡..."
          sudo systemctl start docker
          echo "DockeræœåŠ¡çŠ¶æ€: $(sudo systemctl is-active docker)"
          echo "Dockerç‰ˆæœ¬: $(docker --version)"
          echo "å½“å‰Dockerå®¹å™¨: $(docker ps -a || echo 'æ— å®¹å™¨')"
          
          # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ›‘ æ£€æŸ¥å¹¶åœæ­¢ç°æœ‰å®¹å™¨..."
          if docker ps -q -f name=$CONTAINER_NAME; then
            echo "å‘ç°è¿è¡Œä¸­çš„å®¹å™¨ï¼Œæ­£åœ¨åœæ­¢..."
            docker stop $CONTAINER_NAME
            echo "âœ… å®¹å™¨å·²åœæ­¢"
          else
            echo "æ²¡æœ‰è¿è¡Œä¸­çš„å®¹å™¨"
          fi
          
          if docker ps -aq -f name=$CONTAINER_NAME; then
            echo "åˆ é™¤ç°æœ‰å®¹å™¨..."
            docker rm $CONTAINER_NAME
            echo "âœ… å®¹å™¨å·²åˆ é™¤"
          else
            echo "æ²¡æœ‰éœ€è¦åˆ é™¤çš„å®¹å™¨"
          fi
          
          # åˆ é™¤æ—§é•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ—‘ï¸ æ£€æŸ¥å¹¶åˆ é™¤æ—§é•œåƒ..."
          if docker images -q $IMAGE_NAME; then
            echo "åˆ é™¤æ—§é•œåƒ..."
            docker rmi $IMAGE_NAME
            echo "âœ… æ—§é•œåƒå·²åˆ é™¤"
          else
            echo "æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ—§é•œåƒ"
          fi
          
          # æ¸…ç†é¡¹ç›®ç›®å½•å¹¶é‡æ–°å…‹éš†
          echo "ğŸ“ å‡†å¤‡é¡¹ç›®ç›®å½•..."
          rm -rf $PROJECT_DIR
          echo "å…‹éš†é¡¹ç›®ä»£ç ..."
          git clone $REPO_URL $PROJECT_DIR
          cd $PROJECT_DIR
          echo "âœ… é¡¹ç›®ä»£ç å·²å…‹éš†åˆ°: $(pwd)"
          echo "é¡¹ç›®æ–‡ä»¶: $(ls -la)"
          
          # æ„å»ºDockeré•œåƒ
          echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
          echo "Dockerfileå†…å®¹é¢„è§ˆ:"
          head -10 Dockerfile
          docker build -t $IMAGE_NAME .
          echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
          
          # è¿è¡Œæ–°å®¹å™¨
          echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p 80:8080 \
            -p 8081:8081 \
            $IMAGE_NAME
          
          echo "âœ… å®¹å™¨å·²å¯åŠ¨ï¼Œå®¹å™¨ID: $(docker ps -q -f name=$CONTAINER_NAME)"
          echo "å®¹å™¨è¯¦ç»†ä¿¡æ¯:"
          docker ps --filter name=$CONTAINER_NAME --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
          sleep 30
          
          echo "ğŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€å’Œæ—¥å¿—..."
          echo "å®¹å™¨çŠ¶æ€: $(docker inspect $CONTAINER_NAME --format='{{.State.Status}}')"
          echo "å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰:"
          docker logs --tail 20 $CONTAINER_NAME
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          echo "æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹: http://localhost:8081/healthcheck"
          if curl -f http://localhost:8081/healthcheck > /dev/null 2>&1; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ - æœåŠ¡æ­£å¸¸è¿è¡Œ!"
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†å“åº”:"
            curl -v http://localhost:8081/healthcheck || echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹æ— å“åº”"
          fi
          
          # æµ‹è¯•API
          echo "ğŸ§ª æµ‹è¯•APIç«¯ç‚¹..."
          echo "æµ‹è¯•APIç«¯ç‚¹: http://localhost:80/api/coins"
          API_RESPONSE=$(curl -s -X POST http://localhost:80/api/coins \
            -H "Content-Type: application/json" \
            -d '{"totalAmount": 11.00, "denominations": [500, 200, 100, 50, 20, 10, 5, 2, 1]}')
          
          echo "APIå“åº”çŠ¶æ€ç : $(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:80/api/coins \
            -H "Content-Type: application/json" \
            -d '{"totalAmount": 11.00, "denominations": [500, 200, 100, 50, 20, 10, 5, 2, 1]}')"
          
          if [[ $API_RESPONSE == *"totalAmount"* ]]; then
            echo "âœ… APIæµ‹è¯•é€šè¿‡ - æœåŠ¡åŠŸèƒ½æ­£å¸¸!"
            echo "APIå“åº”: $API_RESPONSE"
          else
            echo "âŒ APIæµ‹è¯•å¤±è´¥"
            echo "å“åº”å†…å®¹: $API_RESPONSE"
            echo "å®¹å™¨æœ€æ–°æ—¥å¿—:"
            docker logs --tail 50 $CONTAINER_NAME
            exit 1
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "ğŸ“Š æœ€ç»ˆéƒ¨ç½²çŠ¶æ€:"
          echo "å®¹å™¨çŠ¶æ€:"
          docker ps --filter name=$CONTAINER_NAME
          echo "ç«¯å£ç›‘å¬çŠ¶æ€:"
          netstat -tlpn | grep -E ':(80|8081) ' || echo "ç«¯å£ç›‘å¬æ£€æŸ¥å¤±è´¥"
          
          # æ¸…ç†æœªä½¿ç”¨çš„Dockeré•œåƒ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„Dockerèµ„æº..."
          docker system prune -f
          
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ! æœåŠ¡åœ°å€:"
          echo "  - API: http://$(curl -s ifconfig.me)/api/coins"
          echo "  - å¥åº·æ£€æŸ¥: http://$(curl -s ifconfig.me):8081/healthcheck"

  notify:
    runs-on: ubuntu-latest
    name: Notify Deployment Status
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment to EC2 was successful!"
        echo "Application is available at: http://${{ secrets.EC2_HOST }}/api/coins"
        
    - name: Notify Failure
      if: needs.test.result == 'failure' || needs.deploy.result == 'failure'
      run: |
        echo "âŒ Pipeline failed!"
        if [[ "${{ needs.test.result }}" == "failure" ]]; then
          echo "Tests failed"
        fi
        if [[ "${{ needs.deploy.result }}" == "failure" ]]; then
          echo "Deployment failed"
        fi
        exit 1 