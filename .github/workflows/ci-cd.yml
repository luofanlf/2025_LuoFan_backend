name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run tests
      run: mvn clean test
      
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AWS EC2
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          # è®¾ç½®å˜é‡
          REPO_URL="https://github.com/${{ github.repository }}.git"
          PROJECT_DIR="/home/ubuntu/tech-challenge"
          CONTAINER_NAME="tech-challenge-backend"
          IMAGE_NAME="tech-challenge-backend"
          
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·
          sudo apt update -y
          
          # å®‰è£…Gitï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰
          if ! command -v git &> /dev/null; then
            sudo apt install -y git
          fi
          
          # å®‰è£…Dockerï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰
          if ! command -v docker &> /dev/null; then
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ubuntu
          fi
          
          # ç¡®ä¿DockeræœåŠ¡è¿è¡Œ
          sudo systemctl start docker
          
          # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if docker ps -q -f name=$CONTAINER_NAME; then
            echo "Stopping existing container..."
            docker stop $CONTAINER_NAME
          fi
          
          if docker ps -aq -f name=$CONTAINER_NAME; then
            echo "Removing existing container..."
            docker rm $CONTAINER_NAME
          fi
          
          # åˆ é™¤æ—§é•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if docker images -q $IMAGE_NAME; then
            echo "Removing old image..."
            docker rmi $IMAGE_NAME
          fi
          
          # æ¸…ç†é¡¹ç›®ç›®å½•å¹¶é‡æ–°å…‹éš†
          rm -rf $PROJECT_DIR
          git clone $REPO_URL $PROJECT_DIR
          cd $PROJECT_DIR
          
          # æ„å»ºDockeré•œåƒ
          echo "Building Docker image..."
          docker build -t $IMAGE_NAME .
          
          # è¿è¡Œæ–°å®¹å™¨
          echo "Starting new container..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p 80:8080 \
            -p 8081:8081 \
            $IMAGE_NAME
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "Waiting for service to start..."
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          echo "Performing health check..."
          if curl -f http://localhost:8081/healthcheck > /dev/null 2>&1; then
            echo "âœ… Health check passed - Service is running properly!"
          else
            echo "âš ï¸ Health check failed - Service might not be ready yet"
          fi
          
          # æµ‹è¯•API
          echo "Testing API..."
          API_RESPONSE=$(curl -s -X POST http://localhost:80/api/coins \
            -H "Content-Type: application/json" \
            -d '{"totalAmount": 11.00, "denominations": [500, 200, 100, 50, 20, 10, 5, 2, 1]}')
          
          if [[ $API_RESPONSE == *"totalAmount"* ]]; then
            echo "âœ… API test passed - Service is working correctly!"
            echo "API Response: $API_RESPONSE"
          else
            echo "âŒ API test failed"
            echo "Response: $API_RESPONSE"
            exit 1
          fi
          
          # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
          echo "Container status:"
          docker ps --filter name=$CONTAINER_NAME
          
          # æ¸…ç†æœªä½¿ç”¨çš„Dockeré•œåƒ
          docker system prune -f
          
          echo "ğŸ‰ Deployment completed successfully!"

  notify:
    runs-on: ubuntu-latest
    name: Notify Deployment Status
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment to EC2 was successful!"
        echo "Application is available at: http://${{ secrets.EC2_HOST }}/api/coins"
        
    - name: Notify Failure
      if: needs.test.result == 'failure' || needs.deploy.result == 'failure'
      run: |
        echo "âŒ Pipeline failed!"
        if [[ "${{ needs.test.result }}" == "failure" ]]; then
          echo "Tests failed"
        fi
        if [[ "${{ needs.deploy.result }}" == "failure" ]]; then
          echo "Deployment failed"
        fi
        exit 1 